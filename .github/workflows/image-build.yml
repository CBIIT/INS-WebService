name: Build Base Image - Alpine
on: pull_request
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  image-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read 
      packages: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Docker Login
      id: login
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract Metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

    - name: Build and Publish
      uses: docker/build-push-action@v3
      with:
        file: ./dockerfiles/cbiit-alpine-base-dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
      

      
#     - name: Build, tag, and push the image to Amazon ECR
#       id: build-image
#       env:
#         ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#         ECR_REPOSITORY: ${{ secrets.REPO_NAME }}
#         IMAGE_TAG: 'cbiit-alpine-linux'
        
#       run: |
#         #d=$(date +%Y.%m.%d--%H.%M)
#         #tag=cbiit-alpine-linux-$d
#         #Build, tag, and push image to Amazon ECR
#         docker build  --file dockerOS/AlpineDockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
#         #Docker push
#         docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
#         echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"


#         name: publish
# on: [push]
# jobs:
# publish-hello-docker-image:
# runs-on: ubuntu-latest
# steps:
# - uses: actions/checkout@v2
# - name: Login to GitHub Container Registry
# uses: docker/login-action@v1
# with:
# registry: ghcr.io
# username: ${{ github.actor }}
# password: ${{ secrets.GITHUB_TOKEN }}
# - name: Build the hello-docker Docker image
# run: |
#        docker build . --tag ghcr.io/deselikem/hello-docker-gcr-demo:latest
#        docker run ghcr.io/deselikem/hello-docker-gcr-demo:latest
#        docker push ghcr.io/deselikem/hello-docker-gcr-demo:latest