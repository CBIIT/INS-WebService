name: Contrast Security SCA
on:
  push:
    branches:
      - "security"
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Cleanup Files 
        run: |
          cp src/main/resources/application.properties.j2 src/main/resources/application.properties

      - name: Build Artifact
        run: mvn clean package -DskipTests

      - name: Prepare Artifact
        run: cp target/Bento-0.0.1.war target/ROOT.war

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ROOT.war
          path: target/ROOT.war

  dependency-tree:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout Repository 
        uses: actions/checkout@v3 

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Create Dependency Tree 
        run: |
          mvn dependency:tree -DoutputFile=maven/dependency-tree.txt

      - name: Upload Dependency Tree
        uses: actions/upload-artifact@v3
        with:
          name: dependencies.txt
          path: maven/dependency-tree.txt

  dependency-analyze:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout Repository 
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Create Dependency Analysis 
        run: |
          mvn dependency:analyze >> dependency-analysis.txt

      - name: Upload Dependency Tree
        uses: actions/upload-artifact@v3
        with:
          name: dependency-analysis.txt
          path: dependency-analysis.txt


  contrast:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Contrast CLI
        run: brew tap contrastsecurity/tap && brew install contrast

      - name: Contrast Auth
        run: |
          contrast auth \
          --api-key ${{ secrets.CONTRAST_API_KEY }} \
          --authorization ${{ secrets.CONTRAST_AUTH_HEADER }} \
          --host ${{ secrets.CONTRAST_API_URL }} \
          --organization-id ${{ secrets.CONTRAST_ORGANIZATION_ID }}

      - name: Check Working Directory
        run: ls -la

      - name: Contrast Audit
        run: |
          contrast audit --track \ 
          --file pom.xml \
          --save spdx \ 
          --application-name CCDI_INS \




      

      # - name: Contrast SCA Action
      #   uses: Contrast-Security-OSS/contrast-sca-action@v1
      #   with:
      #     apiKey: ${{ secrets.CONTRAST_API_KEY }}
      #     orgId: ${{ secrets.CONTRAST_ORGANIZATION_ID }}
      #     authHeader: ${{ secrets.CONTRAST_AUTH_HEADER }}
      #     apiUrl: ${{ secrets.CONTRAST_API_URL }}
      #     filePath: mypath/to/config/files
      #     severity: medium
      #     fail: true